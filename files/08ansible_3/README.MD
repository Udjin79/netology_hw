# Ansible Playbook для установки Clickhouse и Vector

## Обзор

Этот Ansible playbook предназначен для автоматизации настройки и конфигурации Clickhouse и Vector на указанных хостах. Playbook состоит из двух основных частей:

1. **Установка и настройка Clickhouse**
2. **Установка и настройка Vector**

## Структура Playbook

### 1. Установка Clickhouse

Этот раздел playbook отвечает за настройку сервера Clickhouse на хостах, указанных в инвентаре под группой `clickhouse`.

- **Основные функции:**
  - Загрузка и установка пакетов Clickhouse.
  - Запуск службы Clickhouse.
  - Создание базы данных `logs` в Clickhouse.
  - Реализована обработка ошибок с помощью блока `rescue`, который пытается загрузить пакет `clickhouse-common-static` в случае неудачи первоначальной загрузки

- **Параметры:**
  - `clickhouse_version`: Указывает версию Clickhouse, которая будет установлена.
  - `clickhouse_packages`: Определяет список пакетов Clickhouse, которые будут загружены и установлены.

- **Теги и модули Ansible:**
  - Теги: `block`, `rescue`, `become`, `notify`, `meta`, `register`, `failed_when`, `changed_when`.
  - Модули: `get_url`, `dnf`, `service`, `command`, `meta`.

- **Права суперпользователя:**
  - `become: true` используется для выполнения задач от имени суперпользователя, что необходимо для установки пакетов и управления службами.

### 2. Установка и настройка Vector

Этот раздел playbook настраивает Vector на хостах, указанных в инвентаре под группой `vector`.

- **Основные функции:**
  - Загрузка и установка Vector.
  - Развертывание конфигурации Vector с использованием шаблона `vector.j2`.

- **Параметры:**
  - `vector_version`: Определен в переменных и указывает версию Vector для установки.

- **Теги и модули Ansible:**
  - Теги: `become`, `notify`.
  - Модули: `get_url`, `dnf`, `systemd`, `template`.


### 3. Установка и настройка Lighthouse

Этот раздел playbook настраивает Lighthouse на хостах, указанных в инвентаре под группой `lighthouse`.

- **Основные функции:**
  - Установка git
  - Клонирование репозитория LightHouse с GitHub
  - Установка прав доступа к директории LightHouse.
  - Установка репозитория EPEL.
  - Установка Nginx.
  - Копирование конфигурации Nginx для LightHouse из шаблона.
  - Проверка, что Nginx запущен.

- **Параметры:**
  - `lighthouse_nginx_port`: Определен в переменных и указывает порт Nginx.

- **Теги и модули Ansible:**
  - Теги: `become`, `notify`.
  - Модули: `git`, `dnf`, `systemd`, `template`, `file`.

## Дополнительные сведения

- Playbook использует обработчики (handlers), которые позволяют выполнять определенные задачи (например, перезапуск службы) только в том случае, если предыдущая задача привела к изменению состояния системы. В частности используется для перезапуска службы Nginx после развертывания конфигурации.
- Использование прав суперпользователя (`become: true`) необходимо для выполнения задач, требующих повышенных привилегий, таких как установка пакетов и управление службами.
